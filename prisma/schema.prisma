// Prisma Schema para Supabase
// La tabla Profile se linkea con auth.users de Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Profile se crea automáticamente cuando un usuario se registra
// El id es el mismo que auth.users.id de Supabase
// --------------------------------------
// ENUMS
// --------------------------------------

enum Plan {
  STARTER
  PRO
  BUSINESS
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum WorkspaceType {
  PERSONAL
  BUSINESS
}

// Mantenemos esto para casos bordes (ej: gasto personal dentro de una cuenta de negocio)
enum TransactionScope {
  PERSONAL
  BUSINESS
  MIXED
}

enum Frequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  YEARLY
}

// --------------------------------------
// MODELOS
// --------------------------------------

// FUSIONADO: User y Profile son uno solo ahora.
model User {
  id            String    @id @db.Uuid // ID directo de Supabase Auth
  email         String    @unique
  name          String?
  avatarUrl     String?   @map("avatar_url")
  plan          Plan      @default(STARTER)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // El usuario NO tiene transacciones directas, tiene Workspaces.
  workspaces    Workspace[]
  categories    Category[]
}

model Workspace {
  id            String        @id @default(cuid())
  name          String
  type          WorkspaceType @default(BUSINESS)
  currency      String        @default("CLP")

  userId        String        @db.Uuid
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Todo cuelga del Workspace
  transactions  Transaction[]
  accounts      Account[]
  Recurrings Recurring[]
  taxRules      TaxRule[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Account {
  id            String      @id @default(cuid())
  name          String
  balance       Decimal     @default(0.00) @db.Decimal(10, 2)
  isBusiness    Boolean     @default(false)
  archivedAt    DateTime?   // Soft delete - null = activa, con fecha = archivada
  isSystem      Boolean     @default(false) // true = cuenta del sistema (no se puede editar/eliminar)

  // Relación estricta con Workspace (no con User directo)
  workspaceId   String
  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  transactions  Transaction[]
  recurrings    Recurring[]

  // Index para filtrar rápido activas vs archivadas
  @@index([workspaceId, archivedAt])
}

model Category {
  id            String          @id @default(cuid())
  name          String
  icon          String?
  type          TransactionType // Importante: Saber si es cat de ingreso o gasto

  // Opcional: Si es NULL, es una categoría GLOBAL (del sistema)
  // Si tiene ID, es una categoría CUSTOM de ese workspace
  userId        String?         @db.Uuid
  user          User?           @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactions  Transaction[]
  Recurrings Recurring[]

  // Unicidad: En un mismo workspace no puede haber dos categorías iguales.
  // Pero permite duplicados si workspaceId es diferente.
  @@unique([name, userId, type])
  @@index([userId])
}

model Transaction {
  id            String           @id @default(cuid())
  amount        Decimal          @db.Decimal(10, 2)
  date          DateTime         @default(now())
  description   String?

  type          TransactionType
  scope         TransactionScope // Para marcar gastos mixtos

  // Relaciones
  workspaceId   String
  workspace     Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  accountId     String
  account       Account          @relation(fields: [accountId], references: [id])

  categoryId    String?
  category      Category?        @relation(fields: [categoryId], references: [id])

  receiptUrl    String?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model Recurring {
  id            String           @id @default(cuid())
  name          String
  amount        Decimal          @db.Decimal(10, 2)
  frequency     Frequency
  nextPayment   DateTime
  isActive      Boolean          @default(true)
  type          TransactionType
  scope         TransactionScope

  // Relaciones
  workspaceId   String
  workspace     Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Cuenta desde la que se paga/cobra (opcional, usa primera del workspace si no está definida)
  accountId     String?
  account       Account?         @relation(fields: [accountId], references: [id])

  categoryId    String?
  category      Category?        @relation(fields: [categoryId], references: [id])

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model TaxRule {
  id  String  @id @default(cuid())
  name  String
  percentage  Decimal @db.Decimal(5,2)
  isActive  Boolean  @default(true)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}
